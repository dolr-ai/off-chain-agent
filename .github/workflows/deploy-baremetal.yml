name: Deploy to Bare Metal Servers

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: deploy-baremetal-${{ github.ref }}
  cancel-in-progress: false

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PROXY_IMAGE_NAME: ${{ github.repository_owner }}/fly-redis-proxy-offchain

jobs:
  build_check:
    uses: ./.github/workflows/build-check.yml
    with:
      publish-artifact: true

  build-and-push:
    name: Build and Push Docker Images
    needs: build_check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ github.sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-glibc

      - name: Make binary executable
        run: chmod +x target/x86_64-unknown-linux-gnu/release/icp-off-chain-agent

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for offchain-agent
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=long,prefix=
            type=raw,value=latest

      - name: Extract metadata for fly-redis-proxy
        id: meta-proxy
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.PROXY_IMAGE_NAME }}
          tags: |
            type=sha,format=long,prefix=
            type=raw,value=latest

      - name: Build and push offchain-agent image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deploy-baremetal/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push fly-redis-proxy image
        uses: docker/build-push-action@v5
        with:
          context: ./deploy-baremetal/fly-redis-proxy
          file: ./deploy-baremetal/fly-redis-proxy/Dockerfile
          push: true
          tags: ${{ steps.meta-proxy.outputs.tags }}
          labels: ${{ steps.meta-proxy.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  fetch-redis-password:
    name: Fetch Fly Redis Password
    needs: build_check
    runs-on: ubuntu-latest

    outputs:
      password: ${{ steps.redis.outputs.password }}

    steps:
      - name: Install Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Fetch Redis password from Fly
        id: redis
        env:
          FLY_API_TOKEN: ${{ secrets.OFFCHAIN_FLY_API_TOKEN }}
        run: |
          # Get Redis status and extract password from Private URL
          OUTPUT=$(flyctl redis status yral-ml-feed-cache 2>&1)
          REDIS_URL=$(echo "$OUTPUT" | grep "Private URL" | awk '{print $NF}')

          # Extract password first, then mask it immediately
          REDIS_PASSWORD=$(echo "$REDIS_URL" | sed -n 's|redis://default:\([^@]*\)@.*|\1|p')
          if [ -n "$REDIS_PASSWORD" ]; then
            echo "::add-mask::$REDIS_PASSWORD"
            echo "::add-mask::$REDIS_URL"
          fi

          if [ -z "$REDIS_URL" ]; then
            echo "Error: Could not fetch Redis URL from flyctl redis status"
            exit 1
          fi
          if [ -z "$REDIS_PASSWORD" ]; then
            echo "Error: Could not extract Redis password from URL"
            exit 1
          fi
          echo "password=$REDIS_PASSWORD" >> $GITHUB_OUTPUT
          echo "Redis password fetched successfully"

  prepare-servers:
    name: Prepare Server List
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.parse.outputs.servers }}
    steps:
      - name: Parse server IPs
        id: parse
        run: |
          # Convert comma-separated IPs to JSON array
          IPS="${{ vars.BAREMETAL_SERVER_IPS }}"
          JSON=$(echo "$IPS" | tr ',' '\n' | jq -R . | jq -s -c .)
          echo "servers=$JSON" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to Server
    needs: [build-and-push, fetch-redis-password, prepare-servers]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        server: ${{ fromJson(needs.prepare-servers.outputs.servers) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_BARE_METAL_GITHUB_ACTIONS_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ matrix.server }} >> ~/.ssh/known_hosts

      - name: Check server connectivity
        run: |
          ssh -o ConnectTimeout=10 root@${{ matrix.server }} "echo 'Server ${{ matrix.server }} connection successful'"

      - name: Sync deployment files to server
        run: |
          rsync -avz --delete \
            ./deploy-baremetal/ \
            root@${{ matrix.server }}:/home/offchain-agent/

      - name: Log in to GHCR on server
        run: |
          ssh root@${{ matrix.server }} "
            echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          "

      - name: Deploy with Docker Compose
        env:
          GOOGLE_SA_KEY: ${{ secrets.YRAL_OFF_CHAIN_AGENT_GOOGLE_CLOUD_SERVICE_ACCOUNT_JSON_KEY }}
          ALLOYDB_SERVICE_ACCOUNT_JSON: ${{ secrets.ALLOYDB_SERVICE_ACCOUNT_JSON_PROD }}
        run: |
          # Shell-escape JSON secrets
          GOOGLE_SA_KEY_ESCAPED=$(printf '%q' "$GOOGLE_SA_KEY")
          ALLOYDB_SA_JSON_ESCAPED=$(printf '%q' "$ALLOYDB_SERVICE_ACCOUNT_JSON")

          ssh root@${{ matrix.server }} "
            cd /home/offchain-agent

            echo 'Pulling latest images...'
            APP_IMAGE=ghcr.io/${{ github.repository }} \
            PROXY_IMAGE=ghcr.io/${{ github.repository_owner }}/fly-redis-proxy-offchain \
            IMAGE_TAG=${{ github.sha }} \
            docker compose pull

            echo 'Stopping existing containers...'
            docker compose down --remove-orphans || true

            echo 'Starting services...'
            APP_IMAGE=ghcr.io/${{ github.repository }} \
            PROXY_IMAGE=ghcr.io/${{ github.repository_owner }}/fly-redis-proxy-offchain \
            IMAGE_TAG=${{ github.sha }} \
            FLY_API_TOKEN='${{ secrets.OFFCHAIN_FLY_API_TOKEN }}' \
            FLY_REDIS_PASSWORD='${{ needs.fetch-redis-password.outputs.password }}' \
            CF_R2_ACCESS_KEY_TEMP='${{ secrets.HOT_OR_NOT_OFF_CHAIN_AGENT_CLOUDFLARE_R2_ACCESS_KEY_ID }}' \
            CF_R2_SECRET_ACCESS_KEY_TEMP='${{ secrets.HOT_OR_NOT_OFF_CHAIN_AGENT_CLOUDFLARE_R2_SECRET_ACCESS_KEY }}' \
            CF_WORKER_ACCESS_OFF_CHAIN_AGENT_KEY='${{ secrets.CF_WORKER_ACCESS_OFF_CHAIN_AGENT_KEY }}' \
            BACKEND_ADMIN_IDENTITY='${{ secrets.YRAL_DAPP_BACKEND_APP_ADMIN_AND_PROPOSAL_SUBMITTER_IDENTITY_PRIVATE_KEY }}' \
            GOOGLE_SA_KEY=$GOOGLE_SA_KEY_ESCAPED \
            ALLOYDB_SERVICE_ACCOUNT_JSON=$ALLOYDB_SA_JSON_ESCAPED \
            YRAL_CLOUDFLARE_WORKER_GRPC_AUTH_TOKEN='${{ secrets.YRAL_CLOUDFLARE_WORKERS_TO_OFFCHAIN_AGENT_GRPC_AUTH_TOKEN }}' \
            GRPC_AUTH_TOKEN='${{ secrets.OFF_CHAIN_AGENT_GRPC_AUTH_TOKEN }}' \
            YRAL_METADATA_TOKEN='${{ secrets.YRAL_AUTH_METADATA_SERVICE_ACCESS_JWT_TOKEN_FOR_OFFCHAIN_AGENT }}' \
            UPSTASH_VECTOR_READ_WRITE_TOKEN='${{ secrets.UPSTASH_VECTOR_READ_WRITE_TOKEN }}' \
            ML_SERVER_JWT_TOKEN='${{ secrets.ML_SERVER_JWT_TOKEN }}' \
            CLOUDFLARE_STREAM_READ_AND_LIST_ACCESS_TOKEN='${{ secrets.CLOUDFLARE_STREAM_READ_AND_LIST_ACCESS_TOKEN }}' \
            QSTASH_CURRENT_SIGNING_KEY='${{ secrets.QSTASH_CURRENT_SIGNING_KEY }}' \
            CF_IMAGES_API_TOKEN='${{ secrets.CLOUDFLARE_IMAGES_READ_AND_WRITE_API_TOKEN }}' \
            NSFW_GRPC_TOKEN='${{ secrets.TOKEN_TO_SIGN_OUTGOING_CALLS_TO_NSFW_DETECT_SERVICE }}' \
            QSTASH_AUTH_TOKEN='${{ secrets.QSTASH_TOKEN }}' \
            STORJ_INTERFACE_TOKEN='${{ secrets.STORJ_INTERFACE_TOKEN }}' \
            VIDEOHASH_BACKFILL_TOKEN='${{ secrets.VIDEOHASH_BACKFILL_TOKEN }}' \
            STORJ_BACKUP_CANISTER_ACCESS_GRANT='${{ secrets.STORJ_BACKUP_CANISTER_ACCESS_GRANT }}' \
            CANISTER_BACKUP_ALERT_GOOGLE_CHAT_WEBHOOK_URL='${{ secrets.CANISTER_BACKUP_ALERT_GOOGLE_CHAT_WEBHOOK_URL }}' \
            ALLOYDB_INSTANCE='${{ secrets.ALLOYDB_INSTANCE_PROD }}' \
            ALLOYDB_DB_PASSWORD='${{ secrets.ALLOYDB_DB_PASSWORD_PROD }}' \
            CANISTER_BACKUP_CACHE_REDIS_URL='${{ secrets.CANISTER_BACKUP_CACHE_REDIS_URL }}' \
            YRAL_METADATA_NOTIFICATION_API_KEY='${{ secrets.YRAL_METADATA_NOTIFICATION_API_KEY }}' \
            YRAL_AUTH_REDIS_URL='${{ secrets.YRAL_AUTH_REDIS_URL }}' \
            ML_FEED_CACHE_MEMORYSTORE_URL='${{ secrets.ML_FEED_CACHE_MEMORYSTORE_URL }}' \
            LUMALABS_API_KEY='${{ secrets.VIDEOGEN_PROVIDER_LUMALABS_API_KEY }}' \
            YRAL_HON_WORKER_JWT='${{ secrets.YRAL_HON_WORKER_JWT }}' \
            LEADERBOARD_REDIS_URL='${{ secrets.LEADERBOARD_REDIS_URL }}' \
            HETZNER_S3_ACCESS_KEY='${{ secrets.HETZNER_S3_ACCESS_KEY }}' \
            HETZNER_S3_SECRET_KEY='${{ secrets.HETZNER_S3_SECRET_KEY }}' \
            REPLICATE_API_TOKEN='${{ secrets.REPLICATE_API_TOKEN }}' \
            BTC_REWARDS_GCHAT_WEBHOOK_URL='${{ secrets.BTC_REWARDS_GCHAT_WEBHOOK_URL }}' \
            YRAL_OFF_CHAIN_USER_MIGRATION_API_KEY='${{ secrets.YRAL_OFF_CHAIN_USER_MIGRATION_API_KEY }}' \
            SERVICE_CANISTER_MIGRATION_REDIS_URL='${{ secrets.SERVICE_CANISTER_MIGRATION_REDIS_URL }}' \
            ANALYTICS_SERVER_TOKEN='${{ secrets.ANALYTICS_SERVER_TOKEN }}' \
            MILVUS_URL='${{ secrets.MILVUS_URL }}' \
            REPLICATE_WEBHOOK_SIGNING_SECRET='${{ secrets.REPLICATE_WEBHOOK_SIGNING_SECRET }}' \
            KVROCKS_PASSWORD='${{ secrets.KVROCKS_PASSWORD }}' \
            KVROCKS_HOSTS='${{ vars.KVROCKS_HOSTS }}' \
            KVROCKS_CA_CERT='${{ secrets.KVROCKS_CA_CERT }}' \
            KVROCKS_CLIENT_CERT='${{ secrets.KVROCKS_CLIENT_CERT }}' \
            KVROCKS_CLIENT_KEY='${{ secrets.KVROCKS_CLIENT_KEY }}' \
            SCRATCHPAD_DRAGONFLY_HOST='${{ vars.SCRATCHPAD_DRAGONFLY_HOST }}' \
            SCRATCHPAD_DRAGONFLY_PORT='${{ vars.SCRATCHPAD_DRAGONFLY_PORT }}' \
            SCRATCHPAD_DRAGONFLY_PASSWORD='${{ secrets.SCRATCHPAD_DRAGONFLY_PASSWORD }}' \
            docker compose up -d

            echo 'Waiting for services to start...'
            sleep 15

            echo 'Services status:'
            docker compose ps
          "

      - name: Verify deployment
        run: |
          ssh root@${{ matrix.server }} "
            cd /home/offchain-agent
            echo '=== Container Status ==='
            docker compose ps
            echo ''
            echo '=== Container Logs (last 20 lines) ==='
            docker compose logs --tail=20 offchain-agent 2>/dev/null || echo 'Logs not yet available'
          "

  deployment-summary:
    name: Deployment Summary
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment summary
        run: |
          echo "## Bare Metal Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/${{ github.repository }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/${{ github.repository_owner }}/fly-redis-proxy-offchain:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo "- fly-redis-proxy (Fly Redis tunnel for yral-ml-feed-cache)" >> $GITHUB_STEP_SUMMARY
          echo "- offchain-agent (gRPC service on port 50051)" >> $GITHUB_STEP_SUMMARY
          echo "- caddy (TLS termination + HTTP/2 reverse proxy)" >> $GITHUB_STEP_SUMMARY
